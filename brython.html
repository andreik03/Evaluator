<body>
    <form style="display:flex">
        <div>
            <textarea id="user-code" cols="60" rows="15" style="white-space: pre;"></textarea>
            <br>
            <button type="button" onclick="runPythonCode()">Run</button>
        </div>
        <div>
            <div id="user-output" style="background-color:gray;width:300;height:200;white-space: pre-wrap;"></div>
            <input type="text" name="user-input" id="user-input">
            <input type="button" onclick="sendInput()" name="send" id="send" value="Send">
        </div>
    </form>

    <script src="https://cdn.jsdelivr.net/gh/pythonpad/brython-runner/lib/brython-runner.bundle.js"></script>
    <script>
        //tab indenting
        const setTabIndent = () => {

            document.getElementById('user-code').addEventListener('keydown', function (e) {
                if (e.key == 'Tab') {
                    e.preventDefault();
                    var start = this.selectionStart;
                    var end = this.selectionEnd;

                    // set textarea value to: text before caret + tab + text after caret
                    this.value = this.value.substring(0, start) +
                        "    " + this.value.substring(end);

                    // put caret at right position again
                    this.selectionStart =
                        this.selectionEnd = start + 4;
                }
            });
        }

        setTabIndent();

        // code for waiting on Send button
        // this is an async timeout util
        const timeout = async ms => new Promise(res => setTimeout(res, ms));

        let next = false; // this is to be changed on user input

        const sendInput = () => next = true;

        async function waitUserInput() {
            while (next === false) await timeout(50); // pause script but avoid browser to freeze ;)
            next = false; // reset var
        }

        async function runPythonCode() {
            const runner = new BrythonRunner({
                stdout: {
                    write(content) {
                        document.querySelector("#user-output").innerHTML += content;
                        console.log('StdOut: ' + content);
                    },
                    flush() {},
                },
                stderr: {
                    write(content) {
                        document.querySelector("#user-code").value += content;
                        console.error('StdErr: ' + content);
                    },
                    flush() {},
                },
                stdin: {
                    async readline() {
                        await waitUserInput();
                        let userInput = document.querySelector("#user-input").value;
                        console.log('Received StdIn: ' + userInput);
                        return userInput;
                    },
                }
            });
            console.log('Run Code:');
            document.querySelector("#user-output").innerHTML = "";
            await runner.runCode(document.querySelector("#user-code").value);
            console.log('Done.');
        }
    </script>
</body>